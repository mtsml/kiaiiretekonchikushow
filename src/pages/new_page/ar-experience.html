<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR体験</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    .ar-controls {
      position: fixed;
      bottom: 20px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      z-index: 1000;
    }
    .ar-button {
      margin: 0 10px;
      padding: 8px 16px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
    #photo-preview {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #captured-image {
      max-width: 90%;
      max-height: 70%;
      object-fit: contain;
    }
    .preview-controls {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    .preview-button {
      padding: 8px 16px;
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; gpsMinDistance: 5; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960;">
    
    <a-camera gps-camera rotation-reader></a-camera>
    
    <!-- AR entities will be added dynamically via JavaScript -->
  </a-scene>
  
  <div class="ar-controls">
    <button class="ar-button" id="camera-button">写真を撮る</button>
    <button class="ar-button" onclick="window.parent.postMessage('exit-ar', '*')">AR体験を終了</button>
  </div>
  
  <div id="photo-preview">
    <img id="captured-image" alt="撮影した写真">
    <div class="preview-controls">
      <button class="preview-button" id="save-photo">保存</button>
      <button class="preview-button" id="close-preview">閉じる</button>
    </div>
  </div>
  
  <script>
    // カメラボタンの機能を追加
    document.getElementById('camera-button').addEventListener('click', capturePhoto);
    document.getElementById('close-preview').addEventListener('click', closePhotoPreview);
    document.getElementById('save-photo').addEventListener('click', savePhoto);
    
    // 写真を撮影する関数
    function capturePhoto() {
      // AR.jsのキャンバスを取得
      const canvas = document.querySelector('.a-canvas');
      
      try {
        // キャンバスからデータURLを取得
        const imageUrl = canvas.toDataURL('image/png');
        
        // プレビュー画像を設定
        const capturedImage = document.getElementById('captured-image');
        capturedImage.src = imageUrl;
        
        // プレビューを表示
        document.getElementById('photo-preview').style.display = 'flex';
        
        console.log('写真を撮影しましためぐ！');
      } catch (error) {
        console.error('写真の撮影に失敗しましためぐ:', error);
        alert('写真の撮影に失敗しましためぐ。もう一度お試しくださいめぐ。');
      }
    }
    
    // プレビューを閉じる関数
    function closePhotoPreview() {
      document.getElementById('photo-preview').style.display = 'none';
    }
    
    // 写真を保存する関数
    function savePhoto() {
      const imageUrl = document.getElementById('captured-image').src;
      
      // ダウンロードリンクを作成
      const link = document.createElement('a');
      link.href = imageUrl;
      link.download = `ar-photo-${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
      
      // リンクをクリックしてダウンロード
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // プレビューを閉じる
      closePhotoPreview();
    }
    
    // URLからパラメータを取得
    const urlParams = new URLSearchParams(window.location.search);
    // ユーザーの現在位置
    const userLat = parseFloat(urlParams.get('userLat') || 0);
    const userLng = parseFloat(urlParams.get('userLng') || 0);
    // 秋葉原駅の位置（ターゲット位置）
    const targetLat = parseFloat(urlParams.get('targetLat') || 35.698353);
    const targetLng = parseFloat(urlParams.get('targetLng') || 139.773114);
    
    // シーンが読み込まれたらARエンティティを配置
    document.querySelector('a-scene').addEventListener('loaded', () => {
      placeAREntities(targetLat, targetLng);
    });
    
    // 2点間の距離をメートルで計算する関数（ハーバーサイン公式）
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // 地球の半径（メートル）
      const φ1 = lat1 * Math.PI / 180;
      const φ2 = lat2 * Math.PI / 180;
      const Δφ = (lat2 - lat1) * Math.PI / 180;
      const Δλ = (lon2 - lon1) * Math.PI / 180;

      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c; // メートル単位の距離
    }
    
    // 位置情報に基づいてARエンティティを配置する関数
    function placeAREntities(latitude, longitude) {
      console.log('ターゲット位置めぐ:', latitude, longitude);
      console.log('ユーザー位置めぐ:', userLat, userLng);
      
      // ARシーンを取得
      const scene = document.querySelector('a-scene');
      
      // 新しい対象の場所（35.728493054835496, 139.69921490383388）
      const targetLocation = {
        latitude: 35.728493054835496,
        longitude: 139.69921490383388
      };
      
      // 対象の場所にモデルを配置
      const locations = [
        { name: "めぐポイント", lat: targetLocation.latitude, lng: targetLocation.longitude }
      ];
      
      // 各場所の情報を保存する配列
      const placeEntities = [];
      
      // 各場所にモデルを配置
      locations.forEach((location, index) => {
        const lat = location.lat;
        const lng = location.lng;
        
        // 3Dモデルのリスト（ランダムに選択）
        const models = [
          { src: '../../assets/logo-512x512.png', type: 'image', scale: '1 1 1' },
          { src: '../../assets/hellomegkamo.png', type: 'image', scale: '1.2 1.2 1.2' },
          { src: '../../assets/haromegudayo.png', type: 'image', scale: '1.5 1.5 1.5' }
        ];
        
        // ランダムにモデルを選択
        const model = models[Math.floor(Math.random() * models.length)];
        
        // エンティティを作成
        let modelEntity;
        if (model.type === 'image') {
          modelEntity = document.createElement('a-image');
          modelEntity.setAttribute('src', model.src);
        } else {
          modelEntity = document.createElement('a-entity');
          modelEntity.setAttribute('gltf-model', model.src);
        }
        
        modelEntity.setAttribute('look-at', '[gps-camera]');
        modelEntity.setAttribute('scale', model.scale);
        modelEntity.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng}`);
        modelEntity.setAttribute('visible', 'false'); // 初期状態では非表示
        modelEntity.id = `model-${index}`;
        
        // 場所名表示用のテキストを追加
        const nameTextEntity = document.createElement('a-text');
        nameTextEntity.setAttribute('value', location.name);
        nameTextEntity.setAttribute('look-at', '[gps-camera]');
        nameTextEntity.setAttribute('scale', '1 1 1');
        nameTextEntity.setAttribute('position', '0 1.5 0');
        nameTextEntity.setAttribute('align', 'center');
        nameTextEntity.setAttribute('color', 'white');
        nameTextEntity.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng}`);
        nameTextEntity.id = `name-${index}`;
        
        // 距離表示用のテキストを追加
        const distanceTextEntity = document.createElement('a-text');
        distanceTextEntity.setAttribute('value', '');
        distanceTextEntity.setAttribute('look-at', '[gps-camera]');
        distanceTextEntity.setAttribute('scale', '1.2 1.2 1.2');
        distanceTextEntity.setAttribute('position', '0 0.5 0');
        distanceTextEntity.setAttribute('align', 'center');
        distanceTextEntity.setAttribute('color', '#FFFF00');
        distanceTextEntity.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng}`);
        distanceTextEntity.id = `distance-${index}`;
        distanceTextEntity.setAttribute('visible', 'false'); // 初期状態では非表示
        
        // シーンに追加
        scene.appendChild(modelEntity);
        scene.appendChild(nameTextEntity);
        scene.appendChild(distanceTextEntity);
        
        // 場所の情報を保存
        placeEntities.push({
          location: location,
          lat: lat,
          lng: lng,
          modelEntity: modelEntity,
          nameTextEntity: nameTextEntity,
          distanceTextEntity: distanceTextEntity
        });
        
        console.log(`モデルを配置しましためぐ: ${location.name} (${lat}, ${lng})`);
      });
      
      // 位置情報の更新を監視
      startLocationTracking(placeEntities);
    }
    
    // 位置情報の更新を監視する関数
    function startLocationTracking(placeEntities) {
      // 現在位置の更新間隔（ミリ秒）
      const updateInterval = 3000; // 3秒ごとに更新
      
      // 位置情報の更新を定期的に行う
      const watchId = navigator.geolocation.watchPosition(
        (position) => {
          updateDistances(position.coords.latitude, position.coords.longitude, placeEntities);
        },
        (error) => {
          console.error('位置情報の更新に失敗しましためぐ:', error);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
      
      // 初回の距離更新
      updateDistances(userLat, userLng, placeEntities);
      
      // 定期的に距離を更新
      setInterval(() => {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            updateDistances(position.coords.latitude, position.coords.longitude, placeEntities);
          },
          (error) => {
            console.error('位置情報の取得に失敗しましためぐ:', error);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      }, updateInterval);
    }
    
    // 距離表示用の要素を追加
    const distanceDisplay = document.createElement('div');
    distanceDisplay.id = 'distance-display';
    distanceDisplay.style.position = 'fixed';
    distanceDisplay.style.top = '10px';
    distanceDisplay.style.left = '10px';
    distanceDisplay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    distanceDisplay.style.color = 'white';
    distanceDisplay.style.padding = '10px';
    distanceDisplay.style.borderRadius = '5px';
    distanceDisplay.style.fontSize = '16px';
    distanceDisplay.style.zIndex = '1000';
    document.body.appendChild(distanceDisplay);
    
    // 距離を更新する関数
    function updateDistances(userLat, userLng, placeEntities) {
      placeEntities.forEach((place, index) => {
        // ユーザーと場所の距離を計算
        const distance = calculateDistance(userLat, userLng, place.lat, place.lng);
        
        // 常に距離を画面に表示（テスト用）
        distanceDisplay.textContent = `めぐポイントまでの距離: ${Math.round(distance)}m`;
        
        // 距離に応じて表示を切り替え
        if (distance <= 100) {
          // 100m以内の場合
          if (distance <= 10) {
            // 10m以内の場合はモデルを表示
            place.modelEntity.setAttribute('visible', 'true');
            place.nameTextEntity.setAttribute('visible', 'true');
            place.distanceTextEntity.setAttribute('visible', 'true');
            place.distanceTextEntity.setAttribute('value', `あと${Math.round(distance)}m`);
          } else {
            // 10m〜100mの場合は距離を表示
            place.modelEntity.setAttribute('visible', 'false');
            place.nameTextEntity.setAttribute('visible', 'true');
            place.distanceTextEntity.setAttribute('visible', 'true');
            place.distanceTextEntity.setAttribute('value', `あと${Math.round(distance)}m`);
          }
        } else {
          // 100mより遠い場合も距離を表示
          place.modelEntity.setAttribute('visible', 'false');
          place.nameTextEntity.setAttribute('visible', 'true');
          place.distanceTextEntity.setAttribute('visible', 'true');
          place.distanceTextEntity.setAttribute('value', `あと${Math.round(distance)}m`);
        }
        
        console.log(`${place.location.name}までの距離: ${Math.round(distance)}mめぐ`);
      });
    }
  </script>
</body>
</html>
